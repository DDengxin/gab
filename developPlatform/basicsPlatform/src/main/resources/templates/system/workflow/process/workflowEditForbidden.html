<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block th:replace="~{model/Head :: head(~{::title},_,_,_)}">
        <title>流程编辑</title>
    </th:block>
    <link rel="stylesheet" th:href="@{/static/fonts/workflowfont/iconfont.css}">
    <link rel="stylesheet" th:href="@{/static/css/g6.css}">
    <link rel="stylesheet" th:href="@{/static/script/M_select/M_select.css}">
    <script th:src="@{/static/javascript/g6.min.js}"></script>
    <script th:src="@{/static/script/jquery/jquery-1.12.4.min.js}"></script>
    <script th:src="@{/static/script/M_select/M_select.js}"></script>
    <script th:src="@{/static/script/layer/layer.js}"></script>
    <script th:src="@{/static/javascript/g6-plugins.min.js}"></script>
    <script th:src="@{/static/javascript/html2canvas.min.js}"></script>
</head>

<body>
    <div class="changeOper">
        <button id="changeDrag" class="iconfont icon-yidong" title="拖拽模式" onclick="changeModel('drag')"></button>
        <button id="changeEdit" class="iconfont icon-bianji" title="编辑模式" onclick="changeModel('edit')"></button>
        <!-- <button id="changeGrid" class="iconfont icon-wangge" title="网格对齐"></button> -->
    </div>
    <div id="toolBar">
        <!--开始-->
        <button id="addCircleStart" class="iconfont icon-kaishijiedian"></button>
        <!--结束-->
        <button id="addCircleEnd" class="iconfont icon-jieshujiedian"></button>
        <!--圆-->
        <!-- <button id="addCircle" class="iconfont icon-yuan"></button>； -->
        <!--矩形-->
        <button id="addRect" class="iconfont icon-juxing"></button>
        <!--菱形框-->
        <!-- <button id="addLxing" class="iconfont icon-tubiao"></button> -->
        <!--直线-->
        <!-- <button id="addLine" class="iconfont icon-zhixian"></button> -->
        <!-- 箭头直线 -->
        <button id="addArrowLine" class="iconfont icon-ai37"></button>
        <!--箭头折线-->
        <!-- <button id="addPolyLineFlow" class="iconfont icon-jiantouzhexian"></button> -->
    </div>
    <div id="mountNode"></div>
    <div class="tools">
        <i>删除</i> <i class="delete iconfont icon-shanchu"></i>
    </div>

    <div class="workflow_name" id="workflow_name">
        <!-- 流程详情 -->
        <dl class="workflowDesc">
            <dt>流程详情</dt>
            <dd>
                <p>所属系统：</p>
                <div class="select_border">
                    <div class="container">
                        <select name="" class="select" id="workflowSys" onchange="workflowSysChange()">
                            <option value="0">--请选择--</option>
                        </select>
                    </div>
                </div>
            </dd>
            <dd>
                <p>系统模块：</p>
                <div class="select_border">
                    <div class="container">
                        <select name="" class="select" id="workflowModel" onchange="workflowModelchange()">
                        </select>
                    </div>
                </div>
            </dd>
            <dd>
                <p>流程分类：</p> <!-- onchange="workflowCatechange()" -->
                <input type="text" id="workflowCate">
            </dd>
            <!-- <dd>
            <p>流程ID：</p>
            <input type="text" id="workflowID" readonly>
        </dd> -->
            <dd>
                <p>流程名称：</p>
                <input type="text" id="workflowName" onchange="workflowNamechange()">
            </dd>
            <dd>
                <p>业务表单：</p>
                <div class="container">
                    <select name="" class="select" id="bussinessTable" onchange="bussinessTablechange()">
                    </select>
                </div>
            </dd>
            <dd>
                <p>流程描述：</p>
                <textarea name="" id="workflowDesc" onchange="workflowDescchange()"></textarea>
            </dd>
        </dl>

        <!-- 节点编辑 -->
        <dl class="nodesUpdate">
            <dl>
                <dt>流程详情：</dt>
                <dd>
                    <p>流程名称：</p>
                    <input type="text" id="workflowName1" onchange="workflowNamechange()" readonly>
                </dd>
            </dl>
            <dl class="nodesDetails">
                <dt>流程节点</dt>
                <dd>
                    <p>节点ID：</p>
                    <input type="text" id="nodeID" readonly>
                </dd>
                <dd>
                    <p>节点名称：</p>
                    <input type="text" id="nodeName" onchange="nodeNamechange()">
                </dd>
                <dd class="peoKind">
                    <p>
                        办理人类型：
                        <!-- 下拉框 -->
                    </p>
                    <div class="select_border">
                        <div class="container">
                            <select name="" class="select" id="peoCate" onchange="peoCateChange()">
                                <option value="0">SQL表达式</option>
                                <option value="1">指定人员</option>
                                <!-- <option value="2">指定角色</option> -->
                                <option value="3">JAVA类</option>
                                <option value="4">自定义</option>
                            </select>
                        </div>
                    </div>
                </dd>
                <dd class="role">
                    <p class="randomContent">
                        审批角色：
                        <!-- 弹出框 办理人员弹出固定人员的选择框-->
                    </p>
                    <input type="text" id="peoName" onchange="peoNamechange()">
                </dd>
                <dd class="nodeMethods">
                    <p>
                        审批方式：
                        <!-- 下拉框 -->
                    </p>
                    <div class="select_border">
                        <div class="container">
                            <select name="" class="select" id="nodeDel" onchange="nodeDelChange()">
                                <option value="1">单人办理</option>
                                <option value="2">多人办理</option>
                            </select>
                        </div>
                    </div>
                </dd>
            </dl>
        </dl>

        <!-- 边编辑 -->
        <dl class="edgesUpdate">
            <dl>
                <dt>流程详情：</dt>
                <dd>
                    <p>流程名称：</p>
                    <input type="text" id="workflowName2" onchange="workflowNamechange()" readonly>
                </dd>
            </dl>
            <dt>流程线条</dt>
            <dd>
                <p>
                    线条名称:
                </p>
                <input type="text" id="edgeName" onchange="edgeNameChange()">
            </dd>
            <dd class="edgeLine">
                <p>
                    条件表达式名称：
                    <!-- 下拉框 -->
                </p>
                <div>
                    <div class="select_border">
                        <div class="container">
                            <select name="" class="select" id="edgeKind" onchange="edgeKindchange()">
                                <option value="0">--请选择--</option>
                                <option value="1">SQL表达式</option>
                                <option value="2">EL表达式</option>
                            </select>
                        </div>
                    </div>
                </div>
            </dd>
            <dd>
                <p>
                    流程条件:
                    <!-- 弹出框 -->
                </p>
                <input type="text" id="edgeContent" onchange="edgeContentChange()">
            </dd>
            <!-- <dd>
            <p>条件说明：</p>
            <textarea name="" id="edgeDesc" onchange="edgechange()"></textarea>
        </dd> -->
        </dl>


        <div class="toolbox">
            <button id="consoleJSON">保存</button>
            <!-- <button id="downloadImage">保存图片</button> -->
        </div>
    </div>

    <script>

        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] == variable) {
                    return pair[1];
                }
            }
            return (false);
        }


        // 加载流程描述数据
        var workDescData = [];

        // 加载节点数据
        var nodesData = [];

        // 加载边数据
        var edgesData = [];

        // 获取json数据
        var workflowData;


        /*
         * 新增mid = false
         * 修改mid为流程ID
        */
        var mid = getQueryVariable("id");

        if (mid == false) {
            var str = {};
            str.processClassify = '';
            str.processClassifyId = '';
            str.processDescribe = '';
            str.processModule = '';
            str.processName = '';
            str.processSystemType = '';
            str.workflowTableId = '';
            workDescData.push(str);
        } else {
            $.ajax({
                url: '/system/workflow/process/getProcessInstance?processId=' + mid,
                type: 'GET',
                dataType: 'json',
                async: false,
                success: res => {
                    workflowData = JSON.parse(res.data);
                    for (var i in workflowData) {
                        if (i === 'nodes') {
                            nodesData = workflowData[i];
                        }
                        if (i === 'edges') {
                            edgesData = workflowData[i];
                        }
                        if (i === 'describe') {
                            workDescData = workflowData[i];
                        }
                    }
                    ;
                }
            })
        }


        // 流程图描述数据
        var workflowName = document.getElementById('workflowName')
        var workflowName1 = document.getElementById('workflowName1')
        var workflowName2 = document.getElementById('workflowName2')
        var workflowDesc = document.getElementById('workflowDesc')
        var workflowModel = document.getElementById('workflowModel')
        var workflowID = document.getElementById('workflowID')
        var workflowSys = document.getElementById('workflowSys')
        var bussinessTable = document.getElementById('bussinessTable')
        var workflowCate = document.getElementById('workflowCate');


        // 所属系统的下拉框的值workflowSys
        $.ajax({
            url: '/system/right/combobox/rightModule',
            type: 'GET',
            dataType: 'json',
            async: false,
            success: res => {
                for (var i = 0; i < res.length; i++) {
                    $('#workflowSys').append('<option value=' + res[i].id + '>' + res[i].text + '</option>')
                }
            }
        })


        //业务表单下拉框
        $.ajax({
            url: '/system/workflow/linkTable/list?pageIndex=0&pageSize=400',
            type: 'POST',
            dataType: 'json',
            async: false,
            success: res => {
                for (var i = 0; i < res.data.length; i++) {
                    $('#bussinessTable').append('<option value=' + res.data[i].workflowTableId + '>' + res.data[i].workflowTableDescribe + '</option>')
                }
            }
        })

        if (mid == false) {
            workflowName.value = '';
            workflowName1.value = '';
            workflowName2.value = '';
            workflowDesc.value = '';
            workflowModel.value = '';
            workflowSys.value = 0;
            workflowCate.value = '';
        } else {
            workflowName.value = workDescData[0].processName;
            workflowName1.value = workDescData[0].processName;
            workflowName2.value = workDescData[0].processName;
            workflowDesc.value = workDescData[0].processDescribe;
            workflowModel.value = workDescData[0].processModule;
            workflowSys.value = workDescData[0].processSystemType;
            workflowCate.value = workDescData[0].processClassify;
            bussinessTable.value = workDescData[0].workflowTableId;
            // workflowID.value = workDescData[0].id;
        }


        var modelUrl;
        if (workflowSys.value == '0') {
            $("#workflowSys  option[value='0'] ").attr("selected", true);
            $('#workflowModel').attr('disabled', 'disabled');
            $('#workflowCate').attr('disabled', 'disabled');
        } else {
            $("#workflowSys  option[value='0'] ").attr("selected", false);
            workflowSys.value = workDescData[0].processSystemType;
            $('#workflowModel').removeAttr('disabled');
            $('#workflowCate').removeAttr('disabled');
            modelUrl = '/system/right/combobox/menu/' + workflowSys.value + '/ROOT';
        }

        function workflowSysChange() {
            var index = workflowSys.selectedIndex;// selectedIndex代表的是你所选中项的index
            var optionsValue = workflowSys.options[index].value;
            modelUrl = '/system/right/combobox/menu/' + optionsValue + '/ROOT';

            if (optionsValue != '0') {
                workflowSys.value = optionsValue;
                $('#workflowModel').removeAttr('disabled');
                $('#workflowCate').removeAttr('disabled');
                workDescData[0].processSystemType = optionsValue;
                $("#workflowModel").empty();
                modelChangeUrl();
                workDescData[0].processModule = workflowModel.options[0].text;

            } else {
                $("#workflowSys  option[value='0'] ").attr("selected", true);
                $('#workflowModel').attr('disabled', 'disabled');
                $('#workflowCate').attr('disabled', 'disabled');
            }
        }


        //系统模块
        if (workflowSys.value != 0) {
            modelChangeUrl();
        }

        function modelChangeUrl() {
            $.ajax({
                url: modelUrl,
                type: 'GET',
                dataType: 'json',
                async: false,
                success: res => {
                    for (var i = 0; i < res.length; i++) {
                        $('#workflowModel').append('<option value=' + res[i].id + '>' + res[i].text + '</option>')
                    }
                }
            })
        }

        function workflowModelchange() {
            var modelIndex = workflowModel.selectedIndex;// selectedIndex代表的是你所选中项的index
            var modelValue = workflowModel.options[modelIndex].text;
            workDescData[0].processModule = modelValue;
        }


        //弹出框 流程分类 workflowCate
        $('#workflowCate').click(function () {
            layer.open({
                id: 'workflowCateTc',
                type: 2,
                title: '选择流程分类',
                area: ['900px', '550px'],
                fixed: false, //不固定
                maxmin: true,
                content: '/system/right/hierarchyMenuTree.html',
                success: function (layero, index) {
                    // 获取子页面的iframe
                    var body2 = window['layui-layer-iframe' + index];
                    var data = [];
                    var sysData = $('#workflowSys').val();
                    var modelData = $('#workflowModel').val();
                    data.push(sysData)
                    data.push(modelData)
                    body2.child(data);
                }
            });
        })

        function getSysValue() {
            var rowData2 = $('#workflowSys').val();
            return rowData2;
        }

        function GetValue(data) {
            workDescData[0].processClassify = data.rightName;
            workDescData[0].processClassifyId = data.rightId;
        }


        workDescData[0].workflowTableId = bussinessTable.value;

        //业务表单
        function bussinessTablechange() {
            var bussinessTableIndex = bussinessTable.selectedIndex;// selectedIndex代表的是你所选中项的index
            var bussinessTableValue = bussinessTable.options[bussinessTableIndex].value;
            workDescData[0].workflowTableId = bussinessTableValue;
        }

        // 流程名称
        function workflowNamechange() {
            if (workflowName.value === '') {
                layer.tips('名称不能为空', '#workflowName', {
                    tips: [4, 'rgb(21,160,245)'],
                    time: 4000
                });
                workflowName.value = workDescData[0].processName;
                workflowName1.value = workDescData[0].processName;
                workflowName2.value = workDescData[0].processName;
            } else {
                workDescData[0].processName = workflowName.value;
                workflowName1.value = workflowName.value;
                workflowName2.value = workflowName.value;
            }
        }


        //流程描述
        function workflowDescchange() {
            if (workflowDesc.value === '') {
                layer.tips('描述不能为空', '#workflowDesc', {
                    tips: [4, 'rgb(21,160,245)'],
                    time: 4000
                });
                workflowDesc.value = workDescData[0].processDescribe;
            } else {
                workDescData[0].processDescribe = workflowDesc.value;
            }
        }


        // 节点数据
        var nodes = [];
        var nodeName = document.getElementById('nodeName');
        var nodeDel = document.getElementById('nodeDel');//办理方式
        var nodeKind = document.getElementById('nodeKind');//办理人类型
        var peoName = document.getElementById('peoName');//办理人名称


        // if (nodesData.length == 0) {
        //     nodesData.map(el => {
        //         nodes.push({
        //             id: '',
        //             label: '',
        //             shape: '',
        //             size: '',
        //             transactorType: '',
        //             transactor: '',
        //             transactorWay: '',
        //             processType: '',
        //         })
        //     })
        // } else {
        nodesData.map(el => {
            nodes.push({
                id: el.associatedId,
                label: el.linkName,
                shape: el.processType == '1' || el.processType == '3' ? 'circle' : 'rect',
                size: '',
                transactorType: el.transactorType,
                transactor: el.transactor,
                transactorWay: el.transactorWay,
                processType: el.processType,
            })
        })
        // }


        // 边数据
        var edges = [];
        var edgeName = document.getElementById('edgeName');

        edgesData.map(el => {
            edges.push({
                id: el.associatedId,
                associatedId: el.associatedId,
                source: el.linkStratId,
                target: el.linkEndId,
                conditions: el.conditions,
                conditionsContent: el.conditionsContent,
                label: el.label == 'null' ? '' : el.label
            })
        })


        var twidth = document.getElementById('toolBar').offsetWidth;
        var wwidth = document.getElementById('workflow_name').offsetWidth;

        const plugin = new G6.Plugins['layout.dagre']({
            rankdir: 'LR'
        });

        const net = new G6.Net({
            id: 'mountNode',               // dom id
            width: window.innerWidth - twidth - wwidth,
            height: window.innerHeight,    // 画布高
            fitView: 'autoZoom',
            fitViewPadding: 200,
            grid: {
                forceAlign: true, // 是否支持网格对齐
                cell: 22,         // 网格大小
                line: {
                    stroke: 'rgb(241, 241, 241)',
                    lineWidth: 0.5
                }
            },
            plugins: [plugin]
        });

        net.tooltip({
            title: '相关信息', // @type {String} 标题
            split: ':',  // @type {String} 分割符号
            dx: 10,       // @type {Number} 水平偏移
            dy: 10        // @type {Number} 竖直偏移
        });
        net.node().tooltip(['id', 'label']);
        net.edge().tooltip(['id']);
        net.edge().shape('arrow');
        net.edge().shape('arrow').style({ lineWidth: 1 }).color('#666');
        net.node().shape('circle').style({ lineWidth: 1, fill: '#fff' }).color('#666');
        net.source(nodes, edges);
        net.render();
        net.changeData(nodes, edges);


        // 修改时设置流程图有且只能拥有一个开始和结束节点
        let onlyNodes = net.getNodes();
        onlyNodes.map(el => {
            if (el._attrs.model.processType === "1" || el._attrs.model.processType === '3') {
                $("#addCircleStart").attr('disabled', true);
                $("#addCircleEnd").attr('disabled', true);
                $("#addCircleStart").css({ color: 'rgb(223, 219, 219)', cursor: 'not-allowed' });
                $("#addCircleEnd").css({ color: 'rgb(223, 219, 219)', cursor: 'not-allowed' });
            }
            // else {
            //     $("#addCircleStart").attr('disabled', false);
            //     $("#addCircleEnd").attr('disabled', false);
            //     $("#addCircleStart").css({ color: '#000', cursor: 'pointer' });
            //     $("#addCircleEnd").css({ color: '#000', cursor: 'pointer' });
            // }
        })


        // 左侧工具栏
        var i = 1;
        var b = 1;

        // 切换模式按钮
        function changeModel(mode) {
            net.changeMode(mode)
        };

        $('#addCircleStart').on('click', () => {//添加开始节点
            net.beginAdd('node', {
                id: 'id' + i++,
                shape: 'circle',
                label: '登记',
                size: '',
                processType: '1',
                transactor: '',
                transactorId: '',
                transactorType: '',
                transactorWay: '',
                color: '',
                x: '',
                y: ''
            });
            var start = {
                associatedId: 'id' + b++,
                shape: 'rect',
                label: '登记',
                processType: '1',
                transactor: '',
                transactorId: '',
                transactorType: '',
                transactorWay: '',
                color: '',
                x: '',
                y: '',
                size: ''
            };
            start.linkName = start.label;
            delete start.label;
            nodesData.push(start);
            net.refresh();
        })

        $('#addCircleEnd').on('click', () => {//添加结束节点
            net.beginAdd('node', {
                id: 'id' + i++,
                shape: 'circle',
                label: '核准',
                size: '',
                processType: '3',
                transactor: '',
                transactorId: '',
                transactorType: '',
                transactorWay: '',
                color: '',
                x: '',
                y: ''
            });
            var end = {
                associatedId: 'id' + b++,
                shape: 'rect',
                label: '核准',
                processType: '3',
                transactor: '',
                transactorId: '',
                transactorType: '',
                transactorWay: '',
                color: '',
                x: '',
                y: '',
                size: ''
            };
            end.linkName = end.label;
            delete end.label;
            nodesData.push(end);
            net.refresh();
        })


        $('#addRect').on('click', () => {//添加矩形
            net.beginAdd('node', {
                id: 'id' + i++,
                shape: 'rect',
                label: '[未定义]',
                processType: '2',
                transactor: '',
                transactorId: '',
                transactorType: '',
                transactorWay: '',
                color: '',
                x: '',
                y: '',
                size: ''
            });
            var jx = {
                associatedId: 'id' + b++,
                shape: 'rect',
                label: '[未定义]',
                processType: '2',
                transactor: '',
                transactorId: '',
                transactorType: '',
                transactorWay: '',
                color: '',
                x: '',
                y: '',
                size: ''
            };
            jx.linkName = jx.label;
            delete jx.label;
            nodesData.push(jx);
            net.refresh();
        });


        $('#addArrowLine').on('click', () => {//添加箭头直线
            net.beginAdd('edge', {
                id: 'id' + i++,
                shape: 'arrow',
                label: '',
                conditions: '',
                conditionsContent: '',
                controlPoints: '',
                linkEndId: '',
                linkStratId: '',
                linkStratName: '',
                linkEndName: ''
            });
            var arrowLine = {
                associatedId: 'id' + b++,
                shape: 'arrow',
                label: '',
                conditions: '',
                conditionsContent: '',
                controlPoints: '',
                linkEndId: '',
                linkStratId: '',
                linkStratName: '',
                linkEndName: ''
            };
            edgesData.push(arrowLine);
            net.refresh();
        });


        // 修改node/edge文字
        var Util = G6.Util;
        var input = Util.createDOM('<input class="g6-label-input" id="itemLabelChange"/>', {
            position: 'absolute',
            zIndex: 10,
            display: 'none'
        });

        function hasClass(type, className) {
            if (type) {
                const clasees = type.get('class');
                if (clasees && clasees.indexOf(className) !== -1) {
                    return true;
                }
            }
            return false;
        }

        function showInputLabel(node) {
            if (!node) {
                return;
            }
            const group = node.get('group');
            const label = group.findBy(function (child) {
                if (hasClass(child, 'label')) {
                    return true;
                }
                return false;
            });
            const rootGroup = net.get('rootGroup');
            const bbox = Util.getBBox(label, rootGroup);
            const borderWidth = 1;
            const text = label.attr('text');
            clearAllActived();

            input.value = text;
            input.show();
            input.css({
                top: bbox.minY - borderWidth + 'px',
                left: bbox.minX - borderWidth + 61 + 'px',
                width: bbox.width + 'px',
                height: bbox.height + 'px',
                padding: '0px',
                margin: '0px',
                border: borderWidth + 'px solid #999'
            });
            input.focus();
            input.node = node;
        }

        function updateLabel() {
            if (input.visibility) {
                const node = input.node;
                clearAllActived();
                if (input.value !== node.get('model').name) {
                    if (input.value) {
                        net.update(node, {
                            label: input.value
                        });
                    }
                }
                input.hide();
            }
        }

        function clearAllActived() {
            net.clearAllActived();
            net.refresh(false);
        }

        input.hide = function () {
            input.css({
                display: 'none'
            });
            input.visibility = false;
        };
        input.show = function () {
            input.css({
                display: 'block'
            });
            input.visibility = true;
        };

        input.on('keydown', ev => {
            if (ev.keyCode === 13) {
                updateLabel();
            }
        });

        input.on('blur', () => {
            updateLabel();
        });


        //点线操作
        const graphContainer = net.get('graphContainer');//获取图表内部容器
        // graphContainer.appendChild(input);//追加input输入框
        graphContainer.oncontextmenu = function (e) {//阻止默认右键菜单
            return false;
        }
        net.on('contextmenu', ev => {// 鼠标右键点击事件
            var keyNode = net.find(ev.item._attrs.id);
            const item = net.find('id' + i);


            $('.tools').css({
                'display': 'block',
                'position': 'absolute',
                'zIndex': '99',
                'left': ev.frontEvObj.domX + 20,
                'top': ev.frontEvObj.domY - 10
            });
            $('.tools').click(function () {
                if (keyNode) {
                    edgesData.map((el, ind) => {
                        if (ev.item._attrs.id === el.associatedId) {
                            edgesData.splice(ind, 1);
                        }
                    })
                    nodesData.map((e, index) => {
                        if (ev.item._attrs.id === e.associatedId) {
                            nodesData.splice(index, 1);
                        }
                    })
                    net.remove(keyNode);
                }
                // else {
                //     net.remove(item);
                // }
                $('.tools').css('display', 'none');
            })
            net.refresh();
        });

        $('.tools').on('mouseleave', ev => {
            $('.tools').css('display', 'none');
        })


        var items = {};
        var edgeKind = document.getElementById('edgeKind');
        var edgeContent = document.getElementById('edgeContent');
        var peoCate = document.getElementById('peoCate')

        net.on('itemclick', ev => {//子项点击事件
            items = ev.item._attrs;

            if (items.type === 'node') {
                if (items.model.processType === '1') {
                    $('.nodesDetails').css('display', 'none');
                } else {
                    $('.nodesDetails').css('display', 'block');
                }

                if (items.model.processType === '3') {
                    $('.peoKind').css('display', 'none');
                    $('.role').css('display', 'none');
                    $('.nodeMethods').css('display', 'none');
                } else {
                    $('.peoKind').css('display', 'block');
                    $('.role').css('display', 'block');
                    $('.nodeMethods').css('display', 'block');
                }

                $('.nodesUpdate').css('display', 'block');
                $('.workflowDesc').css('display', 'none');
                $('.edgesUpdate').css('display', 'none');
                $('#nodeName').val(items.model.label);
                $('#nodeID').val(items.model.id)

                if (items.model.transactorType === '') {
                    peoCate.value = '0';
                    $('#peoName').val(items.model.transactor);
                    $('#peoName').removeAttr('placeholder');
                } else if (items.model.transactorType === '4') {
                    $('#peoName').attr('placeholder', '默认为当前办理人员');
                    peoCate.value = items.model.transactorType;
                } else {
                    peoCate.value = items.model.transactorType;
                    $('#peoName').val(items.model.transactor);
                    $('#peoName').removeAttr('placeholder');
                }
                peoCateChange();
                nodeDelChange();
            }
            ;

            if (items.type === 'edge') {
                $('.edgesUpdate').css('display', 'block');
                $('.nodesUpdate').css('display', 'none');
                $('.workflowDesc').css('display', 'none');
                $('#edgeContent').val(items.model.conditionsContent);
                $('#edgeName').val(items.model.label);
                edgeKind.value = items.model.conditions;
                if (items.model.conditions == '' || items.model.conditions == null) {
                    edgeKind.value = '0';
                }
                edgeContentJ();
            }
            ;

            //添加转换线条的controlPoints
            if (mid == false) {
                edgesData.map(el => {
                    if (items.id === el.associatedId) {
                        el.controlPoints = JSON.stringify(items.controlPoints).replace(/"/g, '\\"');
                    }
                })
            }
        });


        // 办理人类型
        peoCateDefault();

        function peoCateChange() {
            if (peoCate.value === '0') {
                $('.randomContent').html('表达式');
                $('#peoName').val(items.model.transactor);
            }
            if (peoCate.value === '1') {
                $('.randomContent').html('选择人员');
                $('#peoName').val(items.model.transactor);
            }
            if (peoCate.value === '2') {
                $('.randomContent').html('选择角色');
                $('#peoName').val(items.model.transactor);
            }
            if (peoCate.value === '3') {
                $('.randomContent').html('JAVA类');
                $('#peoName').val(items.model.transactor);
            }
            if (peoCate.value === '4') {
                $('.randomContent').html('EL表达式');
                $('#peoName').attr('placeholder', '默认为当前办理人员');
                $('#peoName').val(items.model.transactor);
            }
            peoCateDefault();
            nodesData.map(el => {
                if (items.id === el.associatedId) {
                    items.model.transactorType = peoCate.value;
                    el.transactorType = peoCate.value;
                }
            })
        }

        function peoCateDefault() {
            $('#peoName').click(function () {
                if (peoCate.value === '0' || peoCate.value === '3' || peoCate.value === '4') {
                    layer.open({
                        id: 'inputExpress',
                        type: 2,
                        title: '输入SQL表达式或者JAVA类或者自定义',
                        area: ['700px', '450px'],
                        fixed: false, //不固定
                        maxmin: false,
                        content: './iframeExp.html',
                        success: function (layero, index) {
                            // 获取子页面的iframe
                            var body = layer.getChildFrame('body', index);
                            var rowData = $('#peoName').val();
                            body.find('#workflowContent').val(rowData)
                        }
                    });
                } else {
                    //审批角色
                    layer.open({
                        id: 'role',
                        type: 2,
                        title: '选择人员',
                        area: ['900px', '550px'],
                        fixed: false, //不固定
                        maxmin: true,
                        content: '/system/user/selectUser.html'
                    });
                }
            })
        }

        var nameContent;

        function GetPeoNameData(nameData) {
            nameContent = nameData;
            nodesData.map(el => {
                if (items.id === el.associatedId) {
                    peoName.value = nameContent;
                    items.model.transactor = nameContent;
                    el.transactor = nameContent;
                }
            })
        }

        function GetPeoMessageData(peoMessage) {
            nodesData.map(el => {
                if (items.id === el.associatedId) {
                    peoName.value = peoMessage.nickName;
                    items.model.transactor = peoName.value;
                    el.transactor = peoName.value;
                    el.transactorId = peoMessage.jobNumber;
                }
            })
        }

        function peoNamechange() {
            if (peoCate.value === '0' || peoCate.value === '3' || peoCate.value === '4') {
                GetPeoNameData(nameData);
            } else {
                GetPeoMessageData(peoMessage);
            }
        }


        // 审批方式
        function nodeDelChange() {
            nodesData.map(el => {
                if (items.id === el.associatedId) {
                    var index = nodeDel.selectedIndex;// selectedIndex代表的是你所选中项的index
                    var optionsValue = nodeDel.options[index].value;
                    el.transactorWay = optionsValue;
                    items.model.transactorWay = optionsValue;
                }
            })
        }


        // 线条名称
        function edgeNameChange() {
            edgesData.map(el => {
                if (items.id === el.associatedId) {
                    el.label = edgeName.value;
                    items.model.label = edgeName.value;
                }
            })
        }


        // 条件表达式
        function edgeContentJ() {
            var edgeKindValue = edgeKind.value;
            if (edgeKindValue == '0') {
                $('#edgeContent').attr('disabled', 'disabled');
                $('#edgeContent').css('cursor', 'not-allow');
            } else {
                // $('#edgeContent').removeAttr('disabled', 'disabled')
            }
        }

        edgeContentJ();

        function edgeKindchange() {
            edgeContentJ();
            edgesData.map(el => {
                if (items.id === el.associatedId) {
                    var index = edgeKind.selectedIndex;// selectedIndex代表的是你所选中项的index
                    var optionsValue = edgeKind.options[index].value;
                    if (optionsValue === '0') {
                        el.conditions = '';
                        optionsValue = '';
                        $('#edgeContent').val('');
                    }
                    el.conditions = optionsValue;
                    items.model.conditions = optionsValue;
                }
            })
        }


        // 流程条件
        var valueContent;

        function GetData(data) {
            valueContent = data;
            edgesData.map(el => {
                if (items.id === el.associatedId) {
                    edgeContent.value = valueContent;
                    items.model.conditionsContent = valueContent;
                    el.conditionsContent = valueContent;
                }
            })
        }

        function edgeContentChange() {
            edgesData.map(el => {
                if (items.id === el.associatedId) {
                    items.model.conditionsContent = edgeContent.value;
                    el.conditionsContent = edgeContent.value;
                }
            })
        }


        //条件表达式内容
        $('#edgeContent').click(function () {
            layer.open({
                type: 2,
                title: '输入流程条件',
                area: ['700px', '450px'],
                fixed: false, //不固定
                maxmin: false,
                content: './iframeCondition.html',
                success: function (layero, index) {
                    // 获取子页面的iframe
                    var body1 = layer.getChildFrame('body', index);
                    var rowData1 = edgeContent.value;
                    body1.find('#workflowContent').val(rowData1)
                }
            });
        })


        net.on('click', () => {  //画布点击事件
            $('.edgesUpdate').css('display', 'none');
            $('.nodesUpdate').css('display', 'none');
            $('.workflowDesc').css('display', 'block');
        })


        //节点名称change事件
        function nodeNamechange() {
            nodesData.map(el => {
                if (items.id === el.associatedId) {
                    if (nodeName.value === '') {
                        layer.tips('节点名称不能为空', '#nodeName', {
                            tips: [4, 'rgb(21,160,245)'],
                            time: 4000
                        });
                        nodeName.value === '' ? nodeName.value = '[未定义]' : nodeName.value = el.linkName;
                    } else {
                        items.model.label = $('#nodeName').val();
                        el.linkName = $('#nodeName').val();
                    }
                }
            })
        }


        net.on('itemmouseenter', ev => {//子项鼠标悬浮
            const item = ev.item;
            net.update(item, {
                color: 'red',
            });
            net.refresh();
        });
        net.on('itemmouseleave', ev => {//子项鼠标离开事件
            const item = ev.item;
            net.update(item, {
                color: null
            });
            net.refresh();
        });
        net.on('itemmousedown', ev => {//子项鼠标按下
            const item = ev.item;
            net.update(item, {
                color: '#9ef'
            });
        });
        net.on('itemmouseup', ev => {//子项鼠标弹起
            const item = ev.item;
            net.update(item, {
                color: 'null'
            });
        });

        net.on('dragmove', () => {//拖拽隐藏
            input.hide();
        });


        if (mid) {

            $('button').attr('disabled', 'disabled');
            $('button').css(
                {
                    color: 'rgb(223, 219, 219)',
                    cursor: 'not-allowed'
                }
            );
            $('select').attr('disabled', 'disabled');
            $('select').css(
                {
                    color: 'rgb(120, 120, 120)',
                    cursor: 'not-allowed'
                }
            );
            $('input').attr('disabled', 'disabled');
            $('input').css(
                {
                    color: 'rgb(120, 120, 120)',
                    cursor: 'not-allowed'
                }
            );
            $('textarea').attr('disabled', 'disabled');
            $('textarea').css(
                {
                    color: 'rgb(120, 120, 120)',
                    cursor: 'not-allowed'
                }
            );
        }

        $('#consoleJSON').on('click', () => {//保存按钮
            let flowItems = net.getNodes();
            let flowEdges = net.getEdges();
            let sourceNodesData;
            let sourceEdgesData;


            let flowEdgesArr = [];
            //得到由同一个节点分叉出的所有线条
            for (var i = 0; i < flowEdges.length - 1; i++) {
                for (var j = i + 1; j < flowEdges.length; j++) {
                    if (flowEdges[i]._attrs.model.source === flowEdges[j]._attrs.model.source) {
                        flowEdgesArr.push(flowEdges[i]._attrs.model.id);
                        flowEdgesArr.push(flowEdges[j]._attrs.model.id);
                    }
                }
            }


            var onlyNodesArr = [];
            var edgeCon = [];
            var resulYlflag = true;
            var resultNodeflag = true;
            var resultExflag = true;
            var resultFzflag = true;

            flowItems.map(el => {
                if (el._attrs.edges.length === 0) {
                    layer.msg('节点有游离，该流程图不合格！！！');
                    resulYlflag = false;
                }

                if (el._attrs.model.processType === '2') {
                    if (el._attrs.edges.length < 2) {
                        layer.msg('节点有游离，该流程图不合格！！！');
                        resulYlflag = false;
                    } else {
                        var resultSflag = [];
                        var resultTflag = [];
                        for (var i = 0; i < el._attrs.edges.length; i++) {
                            if (el._attrs.edges[i]._attrs.model.source == el._attrs.id) {
                                resultSflag.push(el._attrs.edges[i])
                            }
                            if (el._attrs.edges[i]._attrs.model.target == el._attrs.id) {
                                resultTflag.push(el._attrs.edges[i])
                            }
                        }
                        if (resultSflag.length == 0 || resultTflag.length == 0) {
                            layer.msg('节点有游离，该流程图不合格！！！');
                            resulYlflag = false;
                        }
                    }
                }

                if (el._attrs.model.processType === '1' || el._attrs.model.processType === '3') {
                    onlyNodesArr.push(el);
                    if (onlyNodesArr.length > 2) {
                        layer.msg('开始节点和结束节点都只能有一个！！！');
                        resultNodeflag = false;
                    }
                }

                if (el._attrs.model.processType != '1' && el._attrs.model.processType != '3' && el._attrs.model.transactorType != '4') {
                    if (el._attrs.model.transactor == '') {
                        layer.msg('节点中的表达式或者人员必填！！！')
                        resultExflag = false;
                    }
                }

                for (var i = 0; i < el._attrs.edges.length; i++) {
                    if (el._attrs.edges[i]._attrs.model.source == el._attrs.id) {
                        edgeCon.push(el._attrs.edges[i])
                    }
                }
            })


            for (var i = 0; i < edgeCon.length; i++) {
                for (var j = 0; j < flowEdgesArr.length; j++) {
                    if (edgeCon[i]._attrs.id == flowEdgesArr[j]) {
                        var index = i;
                        edgeCon.splice(index, 1);
                    }
                }
            }


            const saveData = net.save();
            sourceNodesData = saveData.source.nodes;
            sourceEdgesData = saveData.source.edges;


            nodesData.map(e => {
                sourceNodesData.map(el => {
                    if (e.associatedId === el.id) {
                        e.x = el.x;
                        e.y = el.y;
                    }
                })
            });

            if (mid == false) {
                edgesData.map(e => {
                    sourceEdgesData.map(el => {
                        if (e.associatedId === el.id) {
                            e.linkStratId = el.source;
                            e.linkEndId = el.target;
                            e.color = el.color;
                        }
                    })
                });
                sourceNodesData.map(el => {
                    edgesData.map(e => {
                        if (el.id == e.linkStratId) {
                            e.linkStratName = el.label
                        }
                        if (el.id == e.linkEndId) {
                            e.linkEndName = el.label
                        }
                    })
                })
            } else {
                edgesData.map(e => {
                    sourceEdgesData.map(el => {
                        if (e.associatedId === el.id) {
                            e.controlPoints = JSON.stringify(el.controlPoints).replace(/"/g, '\\"');
                        }
                    })
                });
            }


            const jsonData = {};
            jsonData.describe = workDescData;


            if (mid == false) {
                var resultNodes = [];
                var resultEdges = [];


                //提出两个数组中相同的值
                for (var i = 0; i < nodesData.length; i++) {
                    var obj1 = nodesData[i];
                    var num1 = obj1.associatedId;
                    for (var j = 0; j < sourceNodesData.length; j++) {
                        var aj1 = sourceNodesData[j];
                        var n1 = aj1.id;
                        if (n1 == num1) {
                            resultNodes.push(obj1);
                        }
                    }
                }

                for (var i = 0; i < edgesData.length; i++) {
                    var obj2 = edgesData[i];
                    var num2 = obj2.associatedId;
                    for (var j = 0; j < sourceEdgesData.length; j++) {
                        var aj2 = sourceEdgesData[j];
                        var n2 = aj2.id;
                        if (n2 == num2) {
                            resultEdges.push(obj2);
                        }
                    }
                }


                resultEdges.map(e => {
                    for (var k = 0; k < resultEdges.length; k++) {
                        for (var i = 0; i < flowEdgesArr.length; i++) {
                            if (resultEdges[k].associatedId == flowEdgesArr[i]) {
                                if (resultEdges[k].conditions === '' || resultEdges[k].conditionsContent === '') {
                                    layer.msg('有多分支的节点的条件表达式和条件内容必填');
                                    resultFzflag = false;
                                }
                            }
                        }
                    }
                })


                resultEdges.map(el => {
                    edgeCon.map(e => {
                        if (el.associatedId == e._attrs.id) {
                            el.conditionsContent = '';
                            el.conditions = '';
                        }
                    })
                })


                jsonData.nodes = resultNodes;
                jsonData.edges = resultEdges;
            } else {
                edgesData.map(e => {
                    flowEdgesArr.map(el => {
                        if (e.associatedId === el) {
                            if (e.conditions === '' || e.conditionsContent === '') {
                                layer.msg('有多分支的节点的条件表达式和条件内容必填');
                                resultFzflag = false;
                            }
                        }
                    })
                })
                jsonData.nodes = nodesData;
                jsonData.edges = edgesData;
            }

            if (resulYlflag && resultNodeflag && resultExflag && resultFzflag) {
                $.ajax({
                    url: '/system/workflow/process/saveProcess',
                    type: 'POST',
                    dataType: 'json',
                    data: JSON.stringify(jsonData),
                    contentType: 'application/json',
                    success: res => {
                        if (res.code == 200) {
                            layer.msg('操作成功！！！');
                        }
                    }
                })
            }
        });
    </script>

</body>

</html>